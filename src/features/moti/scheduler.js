// src/features/moti/scheduler.js
// æœˆåˆãŠçŸ¥ã‚‰ã›ï¼‹æœˆé–“DMãƒªãƒžã‚¤ãƒ³ãƒ‰ï¼ˆcronï¼‰

const cron = require('node-cron');
const { EmbedBuilder } = require('discord.js');

const { runMonthlyDmReminder } = require('./monthlyDmReminder');

const MOTI_NOTICE_CHANNEL_ID = process.env.MOTI_NOTICE_CHANNEL_ID;

let _scheduled = false;

function setupMotiMonthlyReminder(client) {
  // äºŒé‡ç™»éŒ²é˜²æ­¢ï¼ˆå†èµ·å‹•/è¤‡æ•°å‘¼ã³å‡ºã—å¯¾ç­–ï¼‰
  if (_scheduled) return;
  _scheduled = true;

  // æ¯Žæœˆ1æ—¥ 10:00 ã«å®Ÿè¡Œï¼ˆå¿…è¦ãªã‚‰ã“ã“ã¯ãŠå¥½ã¿ã§å¤‰æ›´OKï¼‰
  cron.schedule(
    '0 10 1 * *',
    async () => {
      try {
        if (!MOTI_NOTICE_CHANNEL_ID) {
          console.error('moti reminder: é€šçŸ¥è¡¨ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
          return;
        }

        const channel = await client.channels.fetch(MOTI_NOTICE_CHANNEL_ID);
        if (!channel || !channel.isTextBased()) {
          console.error('moti reminder: é€šçŸ¥è¡¨ãƒãƒ£ãƒ³ãƒãƒ«ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
          return;
        }

        const embed = new EmbedBuilder()
          .setTitle('ðŸ—“ï¸ æœˆåˆã®ã”æ¡ˆå†…ï½œæœˆé–“èª¿æŸ»ãŠã‚ˆã³é€šçŸ¥è¡¨')
          .setColor(0xef4444)
          .setDescription([
            'ä»Šæœˆã‚‚ã‚µãƒ¼ã‚¯ãƒ«é‹å–¶ã¸ã®ã”å”åŠ›ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚',
            'æœ¬ã‚µãƒ¼ã‚¯ãƒ«ã§ã¯ã€æ´»å‹•çŠ¶æ³ã‚’æŠŠæ¡ã—ã‚„ã™ãã™ã‚‹ãŸã‚ã€',
            'ã€æœˆé–“èª¿æŸ»ï¼ˆå¿…é ˆï¼‰ã€‘ã¨ã€ã‚³ãƒ³ãƒ†ã‚¹ãƒˆæˆç¸¾å…¥åŠ›ï¼ˆä»»æ„ï¼‰ã€‘ã‚’å®Ÿæ–½ã—ã¦ãŠã‚Šã¾ã™ã€‚',
            'ãŠæ‰‹æ•°ã‚’ãŠã‹ã‘ã„ãŸã—ã¾ã™ãŒã€ä¸‹è¨˜ã®è¦é ˜ã§ã®ã”å…¥åŠ›ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚',
          ].join('\n'))
          .addFields(
            {
              name: '1ï¸âƒ£ æœˆé–“èª¿æŸ»ï¼ˆå¿…é ˆï¼‰',
              value: [
                'æœ¬ã‚µãƒ¼ã‚¯ãƒ«ã§ã¯ã€å…¨ãƒ¡ãƒ³ãƒãƒ¼ã®çš†ã•ã¾ã«ã€æœˆã«ä¸€åº¦ã®ã€Œæœˆé–“èª¿æŸ»ã€ã¸ã®ã”å›žç­”ã‚’ãŠé¡˜ã„ã—ã¦ãŠã‚Šã¾ã™ã€‚',
                '1ãƒ¶æœˆé–“ã®ãŠãŠã¾ã‹ãªè‚²æˆçŠ¶æ³ã‚’å…±æœ‰ã„ãŸã ãã“ã¨ã§ã€å…¨ä½“ã®æ´»å‹•çŠ¶æ³ã®æŠŠæ¡ã‚„é‹å–¶æ–¹é‡ã®æ¤œè¨Žã«å½¹ç«‹ã¦ã¾ã™ã€‚',
                '',
                '**å…¥åŠ›æ–¹æ³•**',
                'âˆ¥ `/moti_month_input` â€¦ æœˆé–“å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ãã¾ã™ã€‚',
                'ã€€ãƒ»å¯¾è±¡æœˆï¼ˆä»»æ„ï¼‰â€¦ `2025-11` ãªã©ã€‚ç©ºæ¬„ã®å ´åˆã¯ã€Œä»Šæœˆã€ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚',
                'ã€€ãƒ»ä»Šæœˆã®è‚²æˆæ•° â€¦ ç¾åœ¨ã®ç·è‚²æˆæ•°ã‚’å…¥åŠ›(å·®åˆ†ã‚’è‡ªå‹•ã§å¢—åŠ åˆ†ã¨ã—ã¦è¨ˆç®—ã—ã¦ãã‚Œã¾ã™)',
                'ã€€ãƒ»ä»Šæœˆã®ãƒ•ã‚¡ãƒ³æ•° â€¦ ç´¯è¨ˆãƒ•ã‚¡ãƒ³æ•°ã‚’å…¥åŠ›(å·®åˆ†ã‚’è‡ªå‹•ã§å¢—åŠ åˆ†ã¨ã—ã¦è¨ˆç®—ã—ã¦ãã‚Œã¾ã™)',
                '',
                '**ç¢ºèªç”¨**',
                'âˆ¥ `/moti_month_me` â€¦ ã”è‡ªèº«ã®æœˆé–“æŽ¨ç§»ï¼ˆç›´è¿‘6ãƒ¶æœˆï¼‰ã‚’ç¢ºèªã§ãã¾ã™ã€‚',
                'ã€€ ã‚µãƒ¼ã‚¯ãƒ«å¹³å‡ã¨ã®æ¯”è¼ƒã‚‚ã‚ã‚ã›ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚',
              ].join('\n'),
            },
            {
              name: '2ï¸âƒ£ ã‚³ãƒ³ãƒ†ã‚¹ãƒˆæˆç¸¾(ä»»æ„)',
              value: [
                'ã‚³ãƒ³ãƒ†ã‚¹ãƒˆã«ãŠã‘ã‚‹å€‹ã€…ã®æˆç¸¾ã¯ã€ä»»æ„ã§ã®å…¥åŠ›ã¨ãªã‚Šã¾ã™ãŒã€',
                'ã”å”åŠ›ã„ãŸã ã‘ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚',
                '',
                '**å…¥åŠ›ç”¨ï¼ˆä»»æ„ï¼‰**',
                'âˆ¥ `/moti_input` â€¦ æˆç¸¾å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ãã¾ã™ã€‚',
                'ã€€ãƒ»å¯¾è±¡ã‚·ãƒ¼ã‚ºãƒ³ï¼ˆä¾‹: `S35`ã€‚ç©ºæ¬„ã®å ´åˆã¯ç¾åœ¨ã‚·ãƒ¼ã‚ºãƒ³ï¼‰',
                'ã€€ãƒ»ç¾åœ¨ã®é †ä½ï¼ˆæ•°å­—ã®ã¿ï¼‰',
                'ã€€ãƒ»ç¾åœ¨ã®è‚²æˆæ•°ï¼ˆãã®æ™‚ç‚¹ã¾ã§ã®ç´¯è¨ˆå›žæ•°ï¼‰',
                '',
                '**æŒ¯ã‚Šè¿”ã‚Šç”¨**',
                'âˆ¥ `/moti_me` â€¦ ã”è‡ªèº«ã®ç›´è¿‘10ä»¶ã®æˆç¸¾æŽ¨ç§»ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚',
                'âˆ¥ `/moti_summary` â€¦ ç›´è¿‘ã®ã‚·ãƒ¼ã‚ºãƒ³åˆ¥ã‚µãƒžãƒªãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚',
                'âˆ¥ `/moti_summary_all` â€¦ ã“ã‚Œã¾ã§ã®å…¨ã‚·ãƒ¼ã‚ºãƒ³ã®ã‚µãƒžãƒªãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚',
              ].join('\n'),
            },
          )
          .setFooter({ text: 'ã“ã®ãŠçŸ¥ã‚‰ã›ã¯ 3 æ—¥å¾Œã«è‡ªå‹•ã§å‰Šé™¤ã•ã‚Œã¾ã™ã€‚' });

        const msg = await channel.send({
          content: '@everyone',
          embeds: [embed],
          allowedMentions: {
            parse: ['everyone'], // @everyone ã‚’ã¡ã‚ƒã‚“ã¨æœ‰åŠ¹ã«ã™ã‚‹
          },
        });

        // 3æ—¥å¾Œã«è‡ªå‹•å‰Šé™¤
        setTimeout(() => {
          msg.delete().catch(() => {});
        }, 3 * 24 * 60 * 60 * 1000);
      } catch (err) {
        console.error('moti reminder error:', err);
      }
    },
    {
      timezone: 'Asia/Tokyo',
    },
  );

  // æ¯Žæœˆ3æ—¥ 21:00 ã«ã€Œæœˆé–“ãƒ¢ãƒãƒ™æœªå…¥åŠ›è€…ã¸ã®DMãƒªãƒžã‚¤ãƒ³ãƒ‰ã€ã‚’å®Ÿè¡Œ
  cron.schedule(
    '0 21 3 * *',
    () => runMonthlyDmReminder(client, {}),
    {
      timezone: 'Asia/Tokyo',
    },
  );
}

module.exports = { setupMotiMonthlyReminder };
